# Contentrain SQLite Generator Cursor Rules

## ğŸ“ Proje YapÄ±sÄ±

```
@contentrain/sqlite-generator/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts           # Ana generator sÄ±nÄ±fÄ±
â”‚   â”œâ”€â”€ cli.ts             # CLI arayÃ¼zÃ¼
â”‚   â””â”€â”€ core/
â”‚       â”œâ”€â”€ database/      # VeritabanÄ± iÅŸlemleri
â”‚       â”‚   â”œâ”€â”€ connection.ts  # Read-only DB baÄŸlantÄ± yÃ¶netimi
â”‚       â”‚   â”œâ”€â”€ schema.ts      # Optimize edilmiÅŸ ÅŸema yÃ¶netimi
â”‚       â”‚   â””â”€â”€ table.ts       # Tablo iÅŸlemleri ve indeksler
â”‚       â”œâ”€â”€ generator/     # Tablo ve iliÅŸki Ã¼retici
â”‚       â”‚   â”œâ”€â”€ table.ts       # Tablo generator
â”‚       â”‚   â””â”€â”€ relation.ts    # Ä°liÅŸki yÃ¶netimi
â”‚       â”œâ”€â”€ validator/     # Model ve iÃ§erik doÄŸrulayÄ±cÄ±
â”‚       â”‚   â”œâ”€â”€ model.ts       # Model validasyonu
â”‚       â”‚   â””â”€â”€ content.ts     # Ä°Ã§erik validasyonu
â”‚       â”œâ”€â”€ optimizer/     # VeritabanÄ± optimizasyonlarÄ±
â”‚       â”‚   â”œâ”€â”€ index.ts       # Ä°ndeks optimizasyonu
â”‚       â”‚   â””â”€â”€ query.ts       # Sorgu optimizasyonu
â”‚       â””â”€â”€ localization/  # Ã‡oklu dil desteÄŸi
â”‚           â””â”€â”€ manager.ts     # Lokalizasyon yÃ¶netimi
â”œâ”€â”€ test/                  # Test dosyalarÄ±
â”‚   â””â”€â”€ generator.test.ts  # Generator testleri
â””â”€â”€ package.json

# Root dizinde Ornek Contentrain Projesi
/contentrain-sdk/
â””â”€â”€ playground/
    â””â”€â”€ contentrain/
        â”œâ”€â”€ models/        # Model JSON dosyalarÄ±
        â”‚   â”œâ”€â”€ metadata.json     # Model tanÄ±mlamalarÄ±
        â”‚   â””â”€â”€ [modelId].json    # Model alan tanÄ±mlamalarÄ±
        â””â”€â”€ content/       # Ä°Ã§erik JSON dosyalarÄ±
            â”œâ”€â”€ [modelId1]/       # localization: true iÃ§in
            â”‚   â”œâ”€â”€ [code1].json  # Lokalizasyon iÃ§erikler
            â”‚   â””â”€â”€ [code2].json  # Lokalizasyon iÃ§erikler
            â””â”€â”€ [modelId2]/       # localization: false iÃ§in
                â””â”€â”€ [modelId2].json # Ä°Ã§erikler
```

## ğŸ”„ Ä°ÅŸ AkÄ±ÅŸÄ± ve Optimizasyonlar

### 1. Model Metadata Okuma
```typescript
class ContentrainSQLiteGenerator {
  async readModelMetadata(): Promise<ModelMetadata[]> {
    // playground/contentrain/models/metadata.json dosyasÄ±nÄ± oku
    const metadataPath = path.join(this.config.modelsDir, 'metadata.json');
    const metadata = await fs.readJson(metadataPath);

    // Her model iÃ§in:
    // - name: PascalCase model adÄ±
    // - modelId: kebab-case benzersiz ID
    // - localization: Ã‡oklu dil desteÄŸi
    // - type: Veri tipi
    // - isServerless: Sunucusuz mod durumu
    return metadata;
  }
}
```

### 2. Model Field Okuma
```typescript
class ContentrainSQLiteGenerator {
  async readModelFields(modelId: string): Promise<ModelField[]> {
    // playground/contentrain/models/[modelId].json dosyasÄ±nÄ± oku
    const fieldPath = path.join(this.config.modelsDir, `${modelId}.json`);
    const fields = await fs.readJson(fieldPath);

    // Her field iÃ§in:
    // - name: GÃ¶rÃ¼nen ad
    // - fieldId: camelCase benzersiz ID
    // - componentId: Alan tipi
    // - fieldType: Veri tipi
    // - validations: DoÄŸrulama kurallarÄ±
    // - options: Alan seÃ§enekleri
    return fields;
  }
}
```

### 3. Lokalizasyon Dil KodlarÄ± Okuma
```typescript
class ContentrainSQLiteGenerator {
  async readLocalizationCodes(modelId: string): Promise<string[]> {
    // Model lokalize edilmiÅŸ mi kontrol et
    const metadata = await this.readModelMetadata();
    const model = metadata.find(m => m.modelId === modelId);

    if (!model.localization) return [];

    // playground/contentrain/content/[modelId]/ dizinindeki dil dosyalarÄ±nÄ± oku
    // Ã–rnek: tr.json, en.json
    const contentPath = path.join(this.config.contentDir, modelId);
    const files = await fs.readdir(contentPath);

    return files
      .filter(f => f.endsWith('.json'))
      .map(f => path.basename(f, '.json'));
  }
}
```

### 4. Tablo ve Ä°liÅŸki OluÅŸturma
```typescript
class ContentrainSQLiteGenerator {
  async createTables(): Promise<void> {
    const metadata = await this.readModelMetadata();

    for (const model of metadata) {
      // Model fields oku
      const fields = await this.readModelFields(model.modelId);

      // Ana tabloyu oluÅŸtur
      await this.createMainTable(model.modelId, fields);

      // Lokalizasyon tablosu gerekli mi?
      if (model.localization) {
        const localizableFields = this.getLocalizableFields(fields);
        await this.createLocalizationTable(model.modelId, localizableFields);
      }

      // Ä°liÅŸki tablolarÄ±nÄ± oluÅŸtur
      const relations = this.getRelationFields(fields);
      await this.createRelations(model.modelId, relations);
    }
  }
}
```

### 5. Ä°Ã§erik AktarÄ±mÄ±
```typescript
class ContentrainSQLiteGenerator {
  async importContent(): Promise<void> {
    const metadata = await this.readModelMetadata();

    for (const model of metadata) {
      // Model lokalize mi?
      if (model.localization) {
        // Dil kodlarÄ±nÄ± oku
        const languages = await this.readLocalizationCodes(model.modelId);

        // Her dil iÃ§in iÃ§erik aktar
        for (const lang of languages) {
          const content = await this.readLocalizedContent(model.modelId, lang);
          await this.importLocalizedContent(model.modelId, lang, content);
        }
      } else {
        // Tekil iÃ§eriÄŸi aktar
        const content = await this.readContent(model.modelId);
        await this.importContent(model.modelId, content);
      }
    }
  }
}
```

### 6. VeritabanÄ± Optimizasyonu ve HazÄ±rlÄ±k
```typescript
class ContentrainSQLiteGenerator {
  async finalizeDatabase(): Promise<void> {
    // Ä°ndeksleri oluÅŸtur
    await this.createIndexes();

    // VeritabanÄ±nÄ± optimize et
    await this.optimizeDatabase();

    // Read-only moda geÃ§
    await this.setReadOnlyMode();

    // Belirlenen dizine kopyala
    await this.moveToTargetDir();
  }
}
```

### Ana Ä°ÅŸ AkÄ±ÅŸÄ±
```typescript
class ContentrainSQLiteGenerator {
  async generate(): Promise<void> {
    try {
      // 1. Model metadata oku
      const metadata = await this.readModelMetadata();

      // 2. Her model iÃ§in field bilgilerini oku
      for (const model of metadata) {
        const fields = await this.readModelFields(model.modelId);

        // 3. Lokalize modeller iÃ§in dil kodlarÄ±nÄ± oku
        if (model.localization) {
          const languages = await this.readLocalizationCodes(model.modelId);
        }
      }

      // 4. TablolarÄ± ve iliÅŸkileri oluÅŸtur
      await this.createTables();

      // 5. Ä°Ã§erikleri aktar
      await this.importContent();

      // 6. VeritabanÄ±nÄ± hazÄ±rla ve hedef dizine taÅŸÄ±
      await this.finalizeDatabase();

    } catch (error) {
      throw new ContentrainError('SQLite generation failed', error.message);
    }
  }
}
```

## ğŸ”’ GÃ¼venlik ve Optimizasyon

### Read-Only Mod AyarlarÄ±
```typescript
async setReadOnlyMode(): Promise<void> {
  await this.db.exec(`
    PRAGMA query_only = ON;   -- Sadece sorgu modu
    PRAGMA read_only = ON;    -- Read-only mod
  `);

  // Dosya izinlerini read-only yap
  await fs.chmod(this.config.dbPath, 0o444);
}
```

### Performans OptimizasyonlarÄ±
1. Memory-mapped I/O
2. BÃ¼yÃ¼k cache boyutu
3. WITHOUT ROWID tablolarÄ±
4. Optimize edilmiÅŸ indeksler
5. WHERE koÅŸullu indeksler
6. Bulk insert iÅŸlemleri

### Sorgu OptimizasyonlarÄ±
1. Prepared statements
2. Ä°ndeks kullanÄ±mÄ±
3. Materialize view'lar
4. Ä°statistik tablolarÄ±

## ğŸ“Š Alan Tipleri ve Validasyonlar

### Veri Tipleri (dataTypes)
1. **String**
   - `single-line-text`: Tek satÄ±r metin
   - `multi-line-text`: Ã‡ok satÄ±rlÄ± metin
   - `email`: E-posta adresi
   - `url`: URL adresi
   - `slug`: SEO dostu URL
   - `color`: Renk deÄŸeri
   - `json`: JSON veri
   - `md-editor`: Markdown iÃ§erik
   - `rich-text-editor`: Zengin metin

2. **Number**
   - `integer`: Tam sayÄ±
   - `decimal`: OndalÄ±klÄ± sayÄ±
   - `rating`: Derecelendirme
   - `percent`: YÃ¼zde deÄŸeri
   - `phone-number`: Telefon numarasÄ±

3. **Boolean**
   - `checkbox`: Ä°ÅŸaret kutusu
   - `switch`: Anahtar

4. **Date**
   - `date`: Tarih
   - `date-time`: Tarih ve saat

5. **Media**
   - `media`: Medya dosyasÄ±

6. **Relation**
   - `one-to-one`: Tekil iliÅŸki
   - `one-to-many`: Ã‡oklu iliÅŸki

### Validasyon KurallarÄ±
```json
{
  "validations": [
    {
      "title": "Required Field",
      "id": "required-field",
      "property": "required",
      "description": "Alan boÅŸ bÄ±rakÄ±lamaz"
    },
    {
      "title": "Unique Field",
      "id": "unique-field",
      "property": "unique",
      "description": "Benzersiz deÄŸer olmalÄ±"
    },
    {
      "title": "Input Range",
      "id": "input-range-field",
      "property": "input-range",
      "description": "SayÄ±sal aralÄ±k kontrolÃ¼",
      "form": {
        "number-of-stars": {
          "component": "integer",
          "props": {
            "min": 1,
            "max": 10
          }
        }
      }
    }
  ]
}
```

### Alan SeÃ§enekleri (options)
```json
{
  "options": [
    {
      "title": "Use as title field",
      "id": "title-field",
      "property": "title",
      "description": "Ä°liÅŸkilerde ID yerine bu alan deÄŸeri gÃ¶sterilir"
    },
    {
      "title": "Set default value",
      "id": "default-value",
      "property": "default",
      "description": "VarsayÄ±lan deÄŸer atamasÄ±"
    },
    {
      "title": "Number of Stars",
      "id": "number-of-stars",
      "property": "start",
      "description": "Derecelendirme yÄ±ldÄ±z sayÄ±sÄ±"
    },
    {
      "title": "Choose A Model",
      "id": "reference",
      "property": "reference",
      "description": "Referans model seÃ§imi"
    }
  ]
}
```

### SQLite Veri Tipi EÅŸleÅŸtirmeleri
1. **TEXT**
   - TÃ¼m string tipleri (`single-line-text`, `multi-line-text`, `email`, `url`, `slug`, `color`, `json`, `md-editor`, `rich-text-editor`)
   - `phone-number`
   - `media` (dosya yolu)

2. **INTEGER**
   - `integer`
   - `rating`
   - `percent`
   - `checkbox`, `switch` (0/1)
   - `status`

3. **REAL**
   - `decimal`

4. **DATETIME**
   - `date`
   - `date-time`
   - `created_at`
   - `updated_at`

## ğŸ“‹ Model ve Ä°Ã§erik YapÄ±sÄ±

### Model Metadata KurallarÄ±
```json
{
  "name": "ServicesItems",      // PascalCase model adÄ±
  "modelId": "services-items",  // kebab-case benzersiz ID bu ayni zamanda JSON dosyasÄ±nÄ±n adÄ±
  "localization": true,        // Ã‡oklu dil desteÄŸi true ise content/services-items/tr.json ve content/services-items/en.json gibi dosyalar oluÅŸturulur. false ise content/services-items/services-items.json gibi tek dosya oluÅŸturulur.
  "type": "JSON",             // Veri tipi
  "createdBy": "user",        // OluÅŸturan kullanÄ±cÄ±
  "isServerless": false       // Sunucusuz mod durumu eger true ise SQL db oluÅŸturulmaz.
}
```

### Model Alan KurallarÄ±

```typescript
type ContentrainFieldType = 'string' | 'number' | 'boolean' | 'array' | 'date' | 'media' | 'relation';
type ContentrainComponentId = 'single-line-text' | 'multi-line-text' | 'email' | 'url' | 'slug' | 'color' | 'json' | 'md-editor' | 'rich-text-editor' | 'integer' | 'decimal' | 'rating' | 'percent' | 'phone-number' | 'checkbox' | 'switch' | 'date' | 'date-time' | 'media' | 'one-to-one' | 'one-to-many';
```

```json
{
  "name": "BaÅŸlÄ±k",           // GÃ¶rÃ¼nen ad
  "fieldId": "title",         // camelCase benzersiz ID
  "modelId": "services-items", // BaÄŸlÄ± model ID
  "componentId": "text",      // Alan tipi
  "fieldType": "string",      // Veri tipi
  "validations": {           // DoÄŸrulama kurallarÄ±
    "required-field": { "value": true },
    "unique-field": { "value": false }
  },
  "options": {               // Alan seÃ§enekleri
    "placeholder": "Servis baÅŸlÄ±ÄŸÄ± giriniz"
  }
}
```

### Ä°Ã§erik YapÄ±sÄ± KurallarÄ±

#### Lokalizasyonsuz Ä°Ã§erik
```json
// content/[modelId]/[modelId].json
{
  "ID": "unique-uuid",
  "title": "Servis BaÅŸlÄ±ÄŸÄ±",
  "description": "AÃ§Ä±klama",
  "status": "publish",
  "created_at": "2024-01-01T00:00:00.000Z",
  "updated_at": "2024-01-01T00:00:00.000Z"
}
```

#### Lokalizasyonlu Ä°Ã§erik
```json
// content/[modelId]/[locale].json
{
  "ID": "unique-uuid",
  "title": "Service Title",  // Lokalize alan
  "description": "Description", // Lokalize alan
  "status": "publish",              // Sistem alanÄ±
  "created_at": "2024-01-01T00:00:00.000Z",
  "updated_at": "2024-01-01T00:00:00.000Z"
}
```

### Sistem AlanlarÄ±
1. **Zorunlu Alanlar**
   - `ID`: UUID formatÄ±nda birincil anahtar
   - `status`: publish, draft, changed string degerleri
   - `created_at`: OluÅŸturma tarihi (ISO)
   - `updated_at`: GÃ¼ncelleme tarihi (ISO)
   - `scheduled`: Zamanlanmis iceriklerde true olur. Zamanlanmamis icerklerde false ya da yoktur eger yoksa bile false gecilmelidir.

2. **Alan Tipleri**
   - `text`: Tek satÄ±r metin
   - `textarea`: Ã‡ok satÄ±rlÄ± metin
   - `markdown`: Markdown iÃ§erik
   - `number`: SayÄ±sal deÄŸer
   - `boolean`: MantÄ±ksal deÄŸer
   - `date`: Tarih
   - `media`: Medya dosyasÄ±
   - `relation`: Model iliÅŸkisi

3. **Validasyon KurallarÄ±**
   - `required-field`: Zorunlu alan
   - `unique-field`: Benzersiz deÄŸer
   - `min-length`: Minimum uzunluk
   - `max-length`: Maksimum uzunluk
   - `pattern`: Regex pattern
   - `range`: SayÄ±sal aralÄ±k

### Ä°Ã§erik Organizasyonu
```
content/
â”œâ”€â”€ [modelId1]/           # Lokalizasyonlu model
â”‚   â”œâ”€â”€ tr.json          # TÃ¼rkÃ§e iÃ§erik
â”‚   â””â”€â”€ en.json          # Ä°ngilizce iÃ§erik
â””â”€â”€ [modelId2]/          # Lokalizasyonsuz model
    â””â”€â”€ [modelId2].json  # Tekil iÃ§erik
```
### Icerikler icin ve modeller icin tipler
```typescript

export type ContentrainStatus = 'publish' | 'draft' | 'changed';

export interface ModelMetadata {
  name: string
  modelId: string
  localization: boolean
  type: 'JSON'
  createdBy: string
  isServerless: boolean
}

export interface ModelField {
  name: string
  fieldId: string
  modelId: string
  componentId: ContentrainComponentId
  fieldType: ContentrainFieldType
  options: FieldOptions
  validations: FieldValidations
  system?: boolean
  defaultField?: boolean
}

export interface ValidationRule {
  title: string
  id: string
  property: string
  description: string
  form?: Record<string, any>
}

export interface FieldOption {
  title: string
  id: string
  property: string
  description: string
  form?: Record<string, any>
}

export interface ContentItem {
  ID: string
  [key: string]: any
  status: ContentrainStatus
  scheduled?: boolean
  createdAt: string
  updatedAt: string
}

export interface DatabaseConfig {
  memory?: boolean
  readonly?: boolean
  fileMustExist?: boolean
  timeout?: number
  verbose?: boolean
}

export type ContentrainFieldType =
  | 'string'
  | 'number'
  | 'boolean'
  | 'array'
  | 'date'
  | 'media'
  | 'relation';

export type ContentrainComponentId =
  | 'single-line-text'
  | 'multi-line-text'
  | 'email'
  | 'url'
  | 'slug'
  | 'color'
  | 'json'
  | 'md-editor'
  | 'rich-text-editor'
  | 'integer'
  | 'decimal'
  | 'rating'
  | 'percent'
  | 'phone-number'
  | 'checkbox'
  | 'switch'
  | 'date'
  | 'date-time'
  | 'media'
  | 'one-to-one'
  | 'one-to-many';

export interface FieldOptions {
  'title-field'?: {
    value: boolean
  }
  'default-value'?: {
    value: boolean
    form: {
      [key: string]: {
        value: any
      }
    }
  }
  'reference'?: {
    value: boolean
    form: {
      reference: {
        value: string
      }
    }
  }
}

export interface FieldValidations {
  'required-field'?: {
    value: boolean
  }
  'unique-field'?: {
    value: boolean
  }
  'input-range-field'?: {
    value: {
      min: number
      max: number
    }
  }
}
```
### Testler
- tests klasorunde yazilacak
- vitest kullanilacak
- root/playground/contentrain icindeki icerik ve modeller kullanilacak
